/*******************************************************************************
 * Educational Online Test Delivery System 
 * Copyright (c) 2014 American Institutes for Research
 *   
 * Distributed under the AIR Open Source License, Version 1.0 
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 ******************************************************************************/
package org.opentestsystem.shared.test.jetty;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.shared.test.LifecycleManagingTestRunner;
import org.opentestsystem.shared.test.api.InteractiveUser;
import org.opentestsystem.shared.test.interactioncontext.HtmlUnitInteractionResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.test.context.ContextConfiguration;

@RunWith (LifecycleManagingTestRunner.class)
@ContextConfiguration ("classpath:test-context.xml")
public class JettyContainerTests
{

  @Autowired
  private SharedObject        sharedObject;

  @Autowired
  @Qualifier ("alice")
  private InteractiveUser<HtmlUnitInteractionResponse>     alice;

  @Autowired
  @Qualifier ("myApp")
  private JettyWebApplication app;

  @Test
  public void basicContainerTest () throws Throwable {
    sharedObject.setInboundData ("Bonjour, Monde!");
    TestAppIndexPageDriver page = alice.browse (app).expecting (TestAppIndexPageDriver.class);
    page.assertContentSame ("Didn't find expected content", "Bonjour, Monde!");
  }

  @Test
  public void noClassloaderIsolationTest () throws Throwable {
    TestAppIndexPageDriver page = alice.browse (app, "/data/returnclassloader", 10000).expecting (TestAppIndexPageDriver.class);
    page.assertContentSame ("Didn't find expected content", "OK");
    assertEquals ("Not using same classloader", JettyContainerTests.class.getClassLoader (), sharedObject.getOutboundData ());
  }

  @Test
  public void classHierarchyConsistencyTest () throws Throwable {
    TestAppIndexPageDriver page = alice.browse (app, "/data/returnobject", 10000).expecting (TestAppIndexPageDriver.class);
    page.assertContentSame ("Didn't find expected content", "OK");
    assertTrue ("Class hierarchy not consistent", sharedObject.getOutboundData () instanceof SharedObject);
  }

}
